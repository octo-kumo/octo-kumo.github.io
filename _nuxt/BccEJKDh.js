import{b as R,V as m,O as H,c as lt,a as O,d as ct,B as D,R as dt,e as ut,f as q,E as tt,g as et,F,C as pt,M as st,h as mt,G,S as ft,i as gt,j as yt}from"./6G4A7wwE.js";import{M as N,a as wt,l as nt,T as bt}from"./DMA2f3XZ.js";import{d as xt,e as Mt,w as _t,o as St,c as Tt,a as At}from"./Cdy4ovlM.js";import{_ as Ot}from"./mpRoWkBO.js";class vt extends H{constructor(t=document.createElement("div")){super(),this.isCSS2DObject=!0,this.element=t,this.element.style.position="absolute",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.center=new lt(.5,.5),this.addEventListener("removed",function(){this.traverse(function(s){s.element instanceof s.element.ownerDocument.defaultView.Element&&s.element.parentNode!==null&&s.element.remove()})})}copy(t,s){return super.copy(t,s),this.element=t.element.cloneNode(!0),this.center=t.center,this}}const B=new m,X=new R,U=new R,Y=new m,J=new m;class Bt{constructor(t={}){const s=this;let r,u,y,f;const b={objects:new WeakMap},g=t.element!==void 0?t.element:document.createElement("div");g.style.overflow="hidden",this.domElement=g,this.getSize=function(){return{width:r,height:u}},this.render=function(a,l){a.matrixWorldAutoUpdate===!0&&a.updateMatrixWorld(),l.parent===null&&l.matrixWorldAutoUpdate===!0&&l.updateMatrixWorld(),X.copy(l.matrixWorldInverse),U.multiplyMatrices(l.projectionMatrix,X),M(a,a,l),T(a)},this.setSize=function(a,l){r=a,u=l,y=r/2,f=u/2,g.style.width=a+"px",g.style.height=l+"px"};function _(a){a.isCSS2DObject&&(a.element.style.display="none");for(let l=0,e=a.children.length;l<e;l++)_(a.children[l])}function M(a,l,e){if(a.visible===!1){_(a);return}if(a.isCSS2DObject){B.setFromMatrixPosition(a.matrixWorld),B.applyMatrix4(U);const n=B.z>=-1&&B.z<=1&&a.layers.test(e.layers)===!0,o=a.element;o.style.display=n===!0?"":"none",n===!0&&(a.onBeforeRender(s,l,e),o.style.transform="translate("+-100*a.center.x+"%,"+-100*a.center.y+"%)translate("+(B.x*y+y)+"px,"+(-B.y*f+f)+"px)",o.parentNode!==g&&g.appendChild(o),a.onAfterRender(s,l,e));const p={distanceToCameraSquared:S(e,a)};b.objects.set(a,p)}for(let n=0,o=a.children.length;n<o;n++)M(a.children[n],l,e)}function S(a,l){return Y.setFromMatrixPosition(a.matrixWorld),J.setFromMatrixPosition(l.matrixWorld),Y.distanceToSquared(J)}function I(a){const l=[];return a.traverseVisible(function(e){e.isCSS2DObject&&l.push(e)}),l}function T(a){const l=I(a).sort(function(n,o){if(n.renderOrder!==o.renderOrder)return o.renderOrder-n.renderOrder;const p=b.objects.get(n).distanceToCameraSquared,c=b.objects.get(o).distanceToCameraSquared;return p-c}),e=l.length;for(let n=0,o=l.length;n<o;n++)l[n].element.style.zIndex=e-n}}}function K(i,t,s){return i===null?null:(i.point.applyMatrix4(t.matrixWorld),i.distance=i.point.distanceTo(s.ray.origin),i.object=t,i)}const It=parseInt(ut)>=166,C=new dt,Q=new m,Z=new R,Rt=O.prototype.raycast,Ct=D.prototype.raycast,$=new m,w=new O,P=[];function it(i,t){this.isBatchedMesh?Pt.call(this,i,t):Et.call(this,i,t)}function Pt(i,t){if(this.boundsTrees){const s=this.boundsTrees,r=this._drawInfo||this._instanceInfo,u=this._drawRanges||this._geometryInfo,y=this.matrixWorld;w.material=this.material,w.geometry=this.geometry;const f=w.geometry.boundsTree,b=w.geometry.drawRange;w.geometry.boundingSphere===null&&(w.geometry.boundingSphere=new ct);for(let g=0,_=r.length;g<_;g++){if(!this.getVisibleAt(g))continue;const M=r[g].geometryIndex;if(w.geometry.boundsTree=s[M],this.getMatrixAt(g,w.matrixWorld).premultiply(y),!w.geometry.boundsTree){this.getBoundingBoxAt(M,w.geometry.boundingBox),this.getBoundingSphereAt(M,w.geometry.boundingSphere);const S=u[M];w.geometry.setDrawRange(S.start,S.count)}w.raycast(i,P);for(let S=0,I=P.length;S<I;S++){const T=P[S];T.object=this,T.batchId=g,t.push(T)}P.length=0}w.geometry.boundsTree=f,w.geometry.drawRange=b,w.material=null,w.geometry=null}else Ct.call(this,i,t)}function Et(i,t){if(this.geometry.boundsTree){if(this.material===void 0)return;Z.copy(this.matrixWorld).invert(),C.copy(i.ray).applyMatrix4(Z),$.setFromMatrixScale(this.matrixWorld),Q.copy(C.direction).multiply($);const s=Q.length(),r=i.near/s,u=i.far/s,y=this.geometry.boundsTree;if(i.firstHitOnly===!0){const f=K(y.raycastFirst(C,this.material,r,u),this,i);f&&t.push(f)}else{const f=y.raycast(C,this.material,r,u);for(let b=0,g=f.length;b<g;b++){const _=K(f[b],this,i);_&&t.push(_)}}}else Rt.call(this,i,t)}function Dt(i={}){return this.boundsTree=new N(this,i),this.boundsTree}function Wt(){this.boundsTree=null}function jt(i=-1,t={}){if(!It)throw new Error("BatchedMesh: Three r166+ is required to compute bounds trees.");t.indirect&&console.warn('"Indirect" is set to false because it is not supported for BatchedMesh.'),t={...t,indirect:!1,range:null};const s=this._drawRanges||this._geometryInfo,r=this._geometryCount;this.boundsTrees||(this.boundsTrees=new Array(r).fill(null));const u=this.boundsTrees;for(;u.length<r;)u.push(null);if(i<0){for(let y=0;y<r;y++)t.range=s[y],u[y]=new N(this.geometry,t);return u}else return i<s.length&&(t.range=s[i],u[i]=new N(this.geometry,t)),u[i]||null}function zt(i=-1){i<0?this.boundsTrees.fill(null):i<this.boundsTree.length&&(this.boundsTrees[i]=null)}class Ft extends H{_update;objType;constructor(t,s=new m,r=0){super(),this.objType=t,this.position.copy(s),this.rotateY(r),this.load()}async load(){this._update=await wt(this.objType),this.update()}update(){this._update&&(this.updateMatrix(),this._update(this.matrix))}}function L(i,t=0){const s=document.createElement("div");s.className="label",s.textContent=i.name,s.style.backgroundColor="transparent",s.style.textAlign="center";const r=new vt(s);r.position.set(0,t,0),r.layers.set(0),i.add(r)}class kt extends q{constructor(t=new O,s=new m,r=new tt,u=new m(1,1,1)){super();const y=[],f=[],b=[],g=new m,_=new et().getNormalMatrix(t.matrixWorld),M=new R;M.makeRotationFromEuler(r),M.setPosition(s);const S=new R;S.copy(M).invert(),I(),this.setAttribute("position",new F(y,3)),this.setAttribute("uv",new F(b,2)),f.length>0&&this.setAttribute("normal",new F(f,3));function I(){let e=[];const n=new m,o=new m,p=t.geometry,c=p.attributes.position,A=p.attributes.normal;if(p.index!==null){const h=p.index;for(let d=0;d<h.count;d++)n.fromBufferAttribute(c,h.getX(d)),A?(o.fromBufferAttribute(A,h.getX(d)),T(e,n,o)):T(e,n)}else{if(c===void 0)return;for(let h=0;h<c.count;h++)n.fromBufferAttribute(c,h),A?(o.fromBufferAttribute(A,h),T(e,n,o)):T(e,n)}e=a(e,g.set(1,0,0)),e=a(e,g.set(-1,0,0)),e=a(e,g.set(0,1,0)),e=a(e,g.set(0,-1,0)),e=a(e,g.set(0,0,1)),e=a(e,g.set(0,0,-1));for(let h=0;h<e.length;h++){const d=e[h];b.push(.5+d.position.x/u.x,.5+d.position.y/u.y),d.position.applyMatrix4(M),y.push(d.position.x,d.position.y,d.position.z),d.normal!==null&&f.push(d.normal.x,d.normal.y,d.normal.z)}}function T(e,n,o=null){n.applyMatrix4(t.matrixWorld),n.applyMatrix4(S),o?(o.applyNormalMatrix(_),e.push(new k(n.clone(),o.clone()))):e.push(new k(n.clone()))}function a(e,n){const o=[],p=.5*Math.abs(u.dot(n));for(let c=0;c<e.length;c+=3){let A=0,h,d,x,v;const rt=e[c+0].position.dot(n)-p,at=e[c+1].position.dot(n)-p,ht=e[c+2].position.dot(n)-p,W=rt>0,j=at>0,z=ht>0;switch(A=(W?1:0)+(j?1:0)+(z?1:0),A){case 0:{o.push(e[c]),o.push(e[c+1]),o.push(e[c+2]);break}case 1:{if(W&&(h=e[c+1],d=e[c+2],x=l(e[c],h,n,p),v=l(e[c],d,n,p)),j){h=e[c],d=e[c+2],x=l(e[c+1],h,n,p),v=l(e[c+1],d,n,p),o.push(x),o.push(d.clone()),o.push(h.clone()),o.push(d.clone()),o.push(x.clone()),o.push(v);break}z&&(h=e[c],d=e[c+1],x=l(e[c+2],h,n,p),v=l(e[c+2],d,n,p)),o.push(h.clone()),o.push(d.clone()),o.push(x),o.push(v),o.push(x.clone()),o.push(d.clone());break}case 2:{W||(h=e[c].clone(),d=l(h,e[c+1],n,p),x=l(h,e[c+2],n,p),o.push(h),o.push(d),o.push(x)),j||(h=e[c+1].clone(),d=l(h,e[c+2],n,p),x=l(h,e[c],n,p),o.push(h),o.push(d),o.push(x)),z||(h=e[c+2].clone(),d=l(h,e[c],n,p),x=l(h,e[c+1],n,p),o.push(h),o.push(d),o.push(x));break}}}return o}function l(e,n,o,p){const c=e.position.dot(o)-p,A=n.position.dot(o)-p,h=c/(c-A),d=new m(e.position.x+h*(n.position.x-e.position.x),e.position.y+h*(n.position.y-e.position.y),e.position.z+h*(n.position.z-e.position.z));let x=null;return e.normal!==null&&n.normal!==null&&(x=new m(e.normal.x+h*(n.normal.x-e.normal.x),e.normal.y+h*(n.normal.y-e.normal.y),e.normal.z+h*(n.normal.z-e.normal.z))),new k(d,x)}}}class k{constructor(t,s=null){this.position=t,this.normal=s}clone(){const t=this.position.clone(),s=this.normal!==null?this.normal.clone():null;return new this.constructor(t,s)}}q.prototype.computeBoundsTree=Dt;q.prototype.disposeBoundsTree=Wt;O.prototype.raycast=it;D.prototype.computeBoundsTree=jt;D.prototype.disposeBoundsTree=zt;D.prototype.raycast=it;const V=new m(0,-9.81,0),ot=new pt(.02,.02,1,4);ot.rotateX(Math.PI/2);const Gt=new st({color:"#000000",emissive:"#ff0000",emissiveIntensity:1}),E=new mt;E.firstHitOnly=!0;const Nt=new st({color:"#000000",depthTest:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-4,wireframe:!1});class Ht extends O{hittable=!1;options;v=new m;et=0;game;intersects=[];mass=.1;constructor(t,s){super(),this.game=s,this.options=t,this.v.copy(t.startVec),this.position.copy(t.startPos),this.geometry=ot.clone(),this.material=Gt.clone()}update(t,s){if(this.et+=t,this.visible=this.et>=0,this.et<0)return;this.et<t&&(t-=this.et);const r=this.v.length();if(s?.containsPoint(this.position)&&(E.far=r*t,E.set(this.position,this.v),this.checkIntersection()))return;this.v.addScaledVector(V,t);const u=.5*1.225*.01*qt(r/343)*r*r/this.mass,y=this.v.clone().normalize().multiplyScalar(-u).add(V);this.v.addScaledVector(y,t);const f=this.position.clone().addScaledVector(this.v,t);this.lookAt(f),this.position.copy(f),this.visible&&this.position.y<0&&this.game.removeObject(this)}checkIntersection(){if(E.intersectObjects(this.game.hittables,!0,this.intersects),this.intersects.length>0){const t=this.intersects[0].point,s=this.intersects[0].object,r=new et().getNormalMatrix(s.matrixWorld),u=this.intersects[0].face?.normal.clone()||new m,y=u.angleTo(this.v);let f=s;for(;f.parent&&!f.hittable;)f=f.parent;const b=f,g=Math.pow(Math.sin(y),4);if(Math.random()<g-.3)this.v.reflect(u),this.v.multiplyScalar(.2),this.position.copy(t.addScaledVector(this.v,.01));else{b.hittable&&b.hit?.(this),u.applyNormalMatrix(r),u.multiplyScalar(10),u.add(this.intersects[0].point);const _=Nt.clone();_.color.setHex(Math.random()*16777215);const M=new O(new kt(s,t.clone(),new tt().setFromVector3(u),new m(.1,.1,.1)),_);return s.attach(M),this.game.addDecal(M),this.game.removeObject(this),!0}}return!1}}function qt(i){return .1*Math.exp(-3.9*i)+.217/(1+10*Math.pow(i-1.3,2))+2.5/(Math.pow(i,-10)+5.6)}class Lt extends G{_game;camera;top;base;tip;yaw=0;pitch=0;isFiring=!1;fireCooldown=0;firePeriod=.01;hittable=!0;constructor(t){super(),this.name="Turret",this._game=t,nt("airdefence/turret.glb",!0,!0).then(s=>{const[r,u]=s.scene.clone().children[0].children;this.add(r),this.tip??=new H,this.top??=u,this.tip.position.set(0,-.007,.0047),this.top.add(this.tip),this.base??=new G,this.base.add(this.top),this.add(this.base),this.rotate(0,0)}),L(this,.5)}update(t){for(this.fireCooldown-=t,this.fireCooldown<0&&(this.fireCooldown=0);this.isFiring&&this.fireCooldown<=this.firePeriod;)this.fireProjectile()}fireProjectile(){const r=new Ht({drag:!1,gravity:!1,startPos:this.getStartPos(),startVec:new m(300*Math.sin(this.yaw)*Math.cos(this.pitch),300*Math.sin(this.pitch),300*Math.cos(this.yaw)*Math.cos(this.pitch)).applyAxisAngle(new m(0,0,1),Math.random()*.005-.0025).applyAxisAngle(new m(0,1,0),Math.random()*.005-.0025).applyAxisAngle(new m(1,0,0),Math.random()*.005-.0025)},this._game);r.et=-this.fireCooldown-.05,r.update(.05),this.fireCooldown+=this.firePeriod,this._game.addObject(r),this._game.scene.add(r)}getStartPos(){return this.tip?.getWorldPosition(new m)??new m}rotate(t,s){this.yaw=t,this.pitch=s,this.base?.rotation?.set(0,t,0),this.top?.rotation?.set(-s-Math.PI/2,0,0)}}class Xt extends O{time=0;hittable=!0;constructor(t=0){super(new ft(2),new gt({})),this.castShadow=!0,this.receiveShadow=!0,this.time=t}update(t){this.time+=t,this.position.y=5*Math.sin(1*this.time),this.position.x=10*Math.cos(.2*this.time),this.position.z=10*Math.sin(.2*this.time)}}class Ut extends G{dir=new m(0,0,0);vel=new m(0,0,0);hittable=!0;game;constructor(t){super(),this.game=t,this.name="Airship",nt("airdefence/airship.glb",!0,!0).then(s=>{const r=s.scene.clone().children[0];r.scale.set(.1,.1,.1),this.add(r)}),L(this,.5)}update(t,s){}}class Yt extends bt{cssRenderer=new Bt;objects=new Set;hittable=new Set;_hittable=[];turret;aircraft;decals=[];showLabels=!0;constructor(){super(),this.controls.screenSpacePanning=!0,this.controls.enablePan=!0,this.scene.fog.density=.001,this.resetCamera(),new Ft("c0/tree_palm.glb",new m(-1,1,-1),.2*Math.PI*2),this.turret=new Lt(this),this.turret.position.set(0,1,0),this.turret.rotate(Math.PI/2,Math.PI/4);const t={yaw:0,pitch:0};this.gui.add(t,"yaw",-Math.PI,Math.PI,1e-5).onChange(s=>{this.turret.rotate(s,t.pitch)}),this.gui.add(t,"pitch",-Math.PI/2,Math.PI/2,1e-5).onChange(s=>{this.turret.rotate(t.yaw,s)}),this.gui.add(this.turret,"isFiring").name("Firing"),this.gui.add(this,"resetCamera").name("Reset Camera"),this.gui.add(this,"showLabels").name("Show Labels").onChange(s=>{this.cssRenderer.domElement.style.display=s?"block":"none"}),this.addObject(this.turret);for(let s=0;s<10;s++){const r=new Xt(s*Math.PI);r.name="Target #"+(s+1),L(r,1),this.addObject(r)}this.aircraft=new Ut(this),this.aircraft.position.set(10,10,10),this.addObject(this.aircraft),this.cssRenderer.domElement.style.pointerEvents="none",this.cssRenderer.domElement.style.position="absolute",this.cssRenderer.domElement.style.top="0px"}update(t){const s=new yt;this.hittable.forEach(r=>s.expandByObject(r)),this.objects.forEach(r=>r.update(t,s))}updateStats(){super.updateStats(),this.guiStatsEl.textContent+=" D"+this.decals.length+" O"+this.objects.size}addDecal(t){for(t.renderOrder=this.decals.length,this.decals.push(t);this.decals.length>500;){const s=this.decals.shift();s?.parent?.remove(s)}}resetCamera(){this.controls.target.set(0,1,0),this.camera.position.set(2,2,2)}addObject(t){this.objects.add(t),t.hittable&&(this.hittable.add(t),this._hittable=Array.from(this.hittable)),this.scene.add(t)}removeObject(t){this.objects.delete(t),t.hittable&&(this.hittable.delete(t),this._hittable=Array.from(this.hittable)),this.scene.remove(t)}get hittables(){return this._hittable}attach(t){super.attach(t),t&&t.appendChild(this.cssRenderer.domElement)}render(){super.render(),this.showLabels&&this.cssRenderer.render(this.scene,this.camera)}onResize(){super.onResize(),this.cssRenderer.setSize(window.innerWidth,window.innerHeight)}}const Jt=xt({__name:"AirDefenceGame",setup(i){const t=Mt(void 0);return _t(t,s=>{new Yt().attach(s)}),St(()=>{}),(s,r)=>(At(),Tt("div",{id:"air-defence-game-parent",ref_key:"game_container",ref:t},null,512))}}),Vt=Object.assign(Ot(Jt,[["__scopeId","data-v-7363bd3a"]]),{__name:"AirDefenceGame"});export{Vt as default};
