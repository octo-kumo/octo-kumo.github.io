import{d as Z,e as J,U as V,o as tt,c as et,L as it,ad as st,a as nt}from"./Cdy4ovlM.js";import{_ as rt}from"./mpRoWkBO.js";function E(a){let t=a/Math.PI%2;return t<0&&(t+=2),t>1?a:a+Math.PI}class u{static ZERO=new u({});constructor({x:t,y:e}){this.set(t??0,e??0)}_x=0;get x(){return this._x}set x(t){this._x=t}_y=0;get y(){return this._y}set y(t){this._y=t}set(t,e){return t instanceof u?this.set(t.x,t.y):(this.x=t,this.y=e??t,this)}add(t,e){return this.copy().incre(t,e)}minus(t,e){return this.copy().decre(t,e)}incre(t,e){return t instanceof u?this.set(this.x+t.x,this.y+t.y):this.set(this.x+t,this.y+(e??t))}decre(t,e){return t instanceof u?this.decre(t.x,t.y):this.incre(-t,e?-e:void 0)}scale(t,e){return this.set(this.x*t,this.y*(e??t))}multi(t,e){return this.copy().scale(t,e??t)}divide(t){return this.copy().div(t)}div(t){return this.scale(1/t)}snap(t){return this.div(t).round().scale(t)}snapTo(t){return this.copy().snap(t)}norm(){const t=this.len();return t===0?this:this.scale(1/t)}log(){return this.normalized().scale(Math.log(this.len()))}normalized(){return this.copy().norm()}len(){return Math.hypot(this.x,this.y)}len2(){return this.y*this.y+this.x*this.x}angle(){return Math.atan2(this.y,this.x)}cap(t){const e=this.len();return e===0?this:e>t?this.scale(t/e):this}dot(t){return this.x*t.x+this.y*t.y}round(){return this.set(Math.round(this.x),Math.round(this.y))}rounded(){return this.copy().round()}neg(){return this.x=-this.x,this.y=-this.y,this}negate(){return this.copy().neg()}copy(){return new u({x:this.x,y:this.y})}rot90(){return this.set(this.y,-this.x)}rotate90(){return this.copy().rot90()}toString(){return`(${this.x.toFixed(3)}, ${this.y.toFixed(3)})`}}class M{predraw(t){}dashed(t){t.setLineDash([2]),this.draw(t),t.setLineDash([])}}class B extends M{x;y;width;height;constructor(t,e,r,h){super(),this.x=t,this.y=e,this.width=r,this.height=h}draw(t){t.beginPath(),t.rect(this.x,this.y,this.width,this.height),t.closePath(),t.stroke()}translated(t,e){return new B(t+this.x,e+this.y,this.width,this.height)}contains(t){return t.x>this.x&&t.x<this.x+this.width&&t.y>this.y&&t.y<this.y+this.height}}class P extends M{x;y;width;height;constructor(t,e,r,h){super(),this.x=t,this.y=e,this.width=r,this.height=h}draw(t){t.beginPath(),t.ellipse(this.x+this.width/2,this.y+this.height/2,this.width/2,this.height/2,0,0,2*Math.PI),t.closePath(),t.stroke()}translated(t,e){return new P(t+this.x,e+this.y,this.width,this.height)}contains(t){const e=t.x-this.x-this.width/2,r=t.y-this.y-this.height/2;return e*e/this.width/this.width+r*r/this.height/this.height<.25}}class R extends M{x;y;width;height;constructor(t,e,r,h){super(),this.x=t,this.y=e,this.width=r,this.height=h}draw(t){t.beginPath(),t.moveTo(this.x,this.y+this.height/2),t.lineTo(this.x+this.width/2,this.y),t.lineTo(this.x+this.width,this.y+this.height/2),t.lineTo(this.x+this.width/2,this.y+this.height),t.closePath(),t.stroke()}translated(t,e){return new R(t+this.x,e+this.y,this.width,this.height)}contains(t){const e=this.x+this.width/2-t.x,r=this.y+this.height/2-t.y;return Math.max(Math.abs(e/this.width+r/this.height),Math.abs(e/this.width-r/this.height))<.5}}function at(a,t){const e=a.measureText(t);return new k({a:new u({x:-e.width/2,y:e.actualBoundingBoxAscent}),b:new u({x:e.width/2,y:e.actualBoundingBoxAscent})})}function W(a,t,e,r){const h=e.minus(t),c=t.add(e),p=Math.abs(h.y)<Math.abs(h.x),o=p?c.x/2:c.y/2;switch(a.beginPath(),r){case"straight":a.moveTo(t.x,t.y),a.lineTo(e.x,e.y);break;case"axis":moveTo(t.x,t.y),p?(a.lineTo(o,t.y),a.lineTo(o,e.y)):(a.lineTo(t.x,o),a.lineTo(e.x,o)),a.lineTo(e.x,e.y);break;case"curve":moveTo(t.x,t.y),p?a.bezierCurveTo(o,t.y,o,e.y,e.x,e.y):a.bezierCurveTo(t.x,o,e.x,o,e.x,e.y);break}a.closePath()}class k extends M{a;b;constructor({a:t,b:e}){super(),this.a=t??new u({}),this.b=e??new u({})}draw(t){t.beginPath(),t.moveTo(this.a.x,this.a.y),t.lineTo(this.b.x,this.b.y),t.closePath(),t.stroke()}translated(t,e){return new k({a:this.a.add(t,e),b:this.b.add(t,e)})}contains(t){return!1}}class ht extends k{r;normal=new u({});constructor({a:t,b:e,r}){super({a:t,b:e}),this.r=r}predraw(t){this.setNormal();const e=this.getStart(),r=this.getEnd();this.r.total?(t.lineWidth=4,W(t,e,r,"straight"),t.stroke(),t.lineWidth=3,t.strokeStyle=t.background,W(t,e,r,"straight"),t.stroke(),t.strokeStyle=t.foreground,t.lineWidth=1):(W(t,e,r,"straight"),t.stroke())}draw(t){this.setNormal();const e=this.getStart(),r=this.getEnd(),h=r.minus(e),c=e.add(r).div(2);if(this.r.role){const p=r.add(e).div(2),o=E(h.angle()-Math.PI/2)+Math.PI/2;t.save(),t.translate(p.x,p.y),t.rotate(o),t.fillStyle=t.background;const f=t.measureText(this.r.role),w=f.width,g=f.actualBoundingBoxAscent+f.actualBoundingBoxDescent;t.fillRect(-w/2,-g/2,w,g),t.fillStyle=t.foreground,t.fillText(this.r.role,0,0),t.restore()}if(this.r.cardinality){const o=E(h.angle()+Math.PI/2)+((this.r.uniqueIndex||0)%2===(h.x>=0?1:0)?0:Math.PI);c.incre(Math.cos(o)*10,Math.sin(o)*10),t.fillText(this.r.cardinality,c.x,c.y)}}getStart(){return this.a.add(this.normal.multi(this.bouncingIndex(this.r.uniqueIndex??0)+((this.r.dupeCount??0)%2===0?-.5:0)))}getEnd(){return this.b.add(this.normal.multi(this.bouncingIndex(this.r.uniqueIndex??0)+((this.r.dupeCount??0)%2===0?-.5:0)))}setNormal(){this.normal.set(this.b.minus(this.a).rot90().norm().scale(15))}bouncingIndex(t){return t%2===0?-Math.floor(t/2):Math.floor(t/2)+1}}const _=100,S=40;class x extends u{_trueWidth=_;_type;id;name;weak;attributes=[];highlight=!1;constructor({id:t,name:e,weak:r,x:h,y:c,_type:p}){super({x:h,y:c}),this._type=p,this.id=t??crypto.randomUUID(),this.name=e,this.weak=r??!1}predraw(t){t.save(),t.translate(this._x,this._y),this.prepaint(t),t.restore()}draw(t){t.save(),t.translate(this._x,this._y),this.paint(t),t.restore()}prepaint(t){this._trueWidth=this.updateTrueWidth(t),this.attributes.forEach(e=>e.predraw(t))}paint(t){this._trueWidth=this.updateTrueWidth(t),this.attributes.forEach(e=>e.draw(t)),this.drawShape(t),t.fillText(this.name,0,0)}drawShape(t,e){e?e.draw(t):(this.drawShape(t,this.getShape()),this.weak&&this.drawShape(t,this.getShape(this._trueWidth-6,S-6))),t.fillStyle=t.background,t.fill(),t.fillStyle=t.foreground,t.stroke()}getShape(t,e){return t&&e?new B(-t/2,-e/2,t,e):this.getShape(this._trueWidth,S)}getShapeWorld(){return this.getShape().translated(this.x,this.y)}updateTrueWidth(t){return Math.max(_,t.measureText(this.name).width*1.05)}toString(){return`[${this.name} ${super.toString()}]`}toObject(t){return{did:t,id:this.id,name:this.name,outlined:this.weak,type:this._type,x:this.x,y:this.y}}}class D extends x{relations=[];lines=[];addRelation(t){this.relations.push(t),this.revalidate()}removeRelations(t){if(!(!Array.isArray(t)||t.length===0))return t[0]instanceof Number&&(t=t,t=t.sort((e,r)=>r-e),t.forEach(e=>this.relations.splice(e,1))),typeof t[0]=="object"&&(t=t,this.relations=this.relations.filter(e=>!t.includes(e))),this.revalidate(),t}revalidate(){const t=new Map;for(let e=0;e<this.relations.length;e++){const r=this.relations[e];r.index=e,t.set(r.entity.id,(r.uniqueIndex=t.get(r.entity.id)??0)+1)}for(let e=0;e<this.relations.length;e++)this.relations[e].dupeCount=t.get(this.relations[e].entity.id)??0,this.lines[e]=new ht({a:this,b:this.relations[e].entity,r:this.relations[e]})}predraw(t){super.predraw(t),this.lines.forEach(e=>e.predraw(t)),this.lines.forEach(e=>e.draw(t))}getShape(t,e){return t&&e?new R(-t/2,-e/2,t,e):this.getShape(this._trueWidth,S)}drawShape(t,e){e?super.drawShape(t,e):(this.drawShape(t,this.getShape()),this._trueWidth=Math.max(_,t.measureText(this.name).width*1.05),this.weak&&this.drawShape(t,this.getShape(this._trueWidth-15,S-6)))}}class ot extends D{disjoint;constructor({id:t,name:e,weak:r,superclass:h,disjoint:c,x:p,y:o,_type:f}){super({id:t,name:e,weak:r,x:p,y:o,_type:f}),this.disjoint=!!c,h&&this.addRelation({entity:h})}drawShape(t,e){e?(this.relations.length===2?e.dashed(t):e.draw(t),t.fillStyle=t.background,t.fill(),t.fillStyle=t.foreground,t.stroke()):this.drawShape(t,this.getShape())}paint(t){this.attributes.forEach(e=>e.draw(t)),this.drawShape(t),this.relations.length!==2&&t.fillText(this.name,0,0)}getShape(t,e){return t&&e?new P(-e*.25,-e*.25,e*.5,e*.5):this.getShape(this._trueWidth,S)}toObject(t){return{disjoint:this.disjoint,...super.toObject(t)}}}class U extends x{parent;_parent;key;derived;type;constructor({id:t,name:e,weak:r,key:h,derived:c,type:p,parent:o,x:f,y:w,_parent:g,_type:m}){super({id:t,name:e,weak:r,x:f,y:w,_type:m}),this.key=h??!1,this.derived=c??!1,this.type=p??"string",this.parent=o,this._parent=g}get y(){return this._y+(this.parent?.y??0)}set y(t){this._y=t-(this.parent?.y??0)}get x(){return this._x+(this.parent?.x??0)}set x(t){this._x=t-(this.parent?.x??0)}drawShape(t,e){e?this.derived?e.dashed(t):e.draw(t):super.drawShape(t),t.fillStyle=t.background,t.fill(),t.fillStyle=t.foreground,t.stroke()}prepaint(t){super.prepaint(t),new k({b:this.truePosition().neg()}).draw(t)}paint(t){if(super.paint(t),this.key){const e=at(t,this.name).translated(0,3);this.parent instanceof x&&this.parent?.weak?e.dashed(t):this.drawShape(t,e)}}getShape(t,e){return t&&e?new P(-t/2,-e*.7/2,t,e*.7):this.getShape(this._trueWidth*.7,S)}truePosition(){return new u({x:this._x,y:this._y})}setParent(t){const e=this.copy();return this.parent=t,this.set(e),this.parent}updateTrueWidth(t){return Math.max(_*.7,t.measureText(this.name).width*1.05)}toObject(t){return{isDerived:this.derived,isKey:this.key,pid:this.parent?.id??null,...super.toObject(t)}}}class O extends x{}function j(a){switch(a){case"attribute":return U;case"relationship":return D;case"entity":return O;case"specialization":return ot;default:return null}}function A(a){return[...a,...a.flatMap(t=>A(t.attributes))]}const lt={id:"er-editor",class:"w-full h-full overflow-hidden relative"},$=0,dt=Z({__name:"evil-er-web",setup(a){const t=J(null),e=V([]);function r(){const i=document.createElement("canvas").getContext("2d"),s=window.devicePixelRatio||1,n=i.webkitBackingStorePixelRatio||i.mozBackingStorePixelRatio||i.msBackingStorePixelRatio||i.oBackingStorePixelRatio||i.backingStorePixelRatio||1;return s/n}let h="",c=0,p=0,o=0,f=new u({x:200,y:200}),w=1,g=new u({}),m=new u({}),C=new u({}),b=new u({}),y=null;tt(()=>{c=r(),I(),fetch("json/erdiagram.json").then(i=>i.json()).then(i=>{const s=(n,l)=>{for(let d of n.attributes){d.parent=l,d._parent=l.id;const T=new U(d);s(d,T),l.attributes.push(T)}};for(const n of i){const l=j(n.type);if(!l)continue;const d=new l(n);e.push(d),s(n,d)}for(let n of i){const l=e.find(d=>d.id===n.id);if(n.type==="relationship"||n.type==="specialization")for(let d=0;d<n.nodes.length;d++)l.addRelation({entity:e.find(T=>T.name===n.nodes[d]),cardinality:n.specs[d].amm,role:n.specs[d].role,total:n.specs[d].total})}})});function I(){if(!t)return;const i=t.value?.getContext("2d");i&&(i.foreground=getComputedStyle(t.value).getPropertyValue("--el-text-color-primary"),i.background=getComputedStyle(t.value).getPropertyValue("--el-bg-color"),z(t.value,i),i.save(),e.forEach(s=>s.predraw(i)),e.forEach(s=>s.draw(i)),y&&(i.strokeStyle=getComputedStyle(t.value).getPropertyValue("--el-color-primary"),y.getShapeWorld().draw(i),i.strokeStyle=i.foreground),L(),requestAnimationFrame(()=>I()))}function z(i,s){const n=document.querySelector("#er-editor");i.width=n.clientWidth*c;let l=n.clientHeight;i.height=l*c,s.fillStyle=s.foreground,s.font="plain 24px serif",s.setTransform(c,0,0,c,0,0),F(s),s.translate(.5,.5),s.scale(w,w),s.translate(f.x,f.y),s.fillRect(m.x,m.y,10,10),s.textAlign="center",s.textBaseline="middle"}function F(i){let s=0;i.fillText(`fps: ${o.toFixed(2)}`,10,s+=10),i.fillText(`scale: ${w.toFixed(2)}`,10,s+=10),i.fillText(`origin: ${f.x.toFixed(2)}, ${f.y.toFixed(2)}`,10,s+=10),i.fillText(`screen: (${window.innerWidth}, ${window.innerHeight}) x${c}→ (${i.canvas.width}, ${i.canvas.height})`,10,s+=10),i.fillText(`entities: ${e.length}`,10,s+=10),i.fillText(`state = ${h}`,10,s+=20),i.fillText("er-editor demo, a shadow of its former version (SQL+Sockets+Live+Colab)",10,s+=10),y&&i.fillText(`selected = ${y}`,10,s+=10)}function L(){const i=(performance.now()-p)/1e3;p=performance.now(),o=1/i}function N(i){const s=t.value.getBoundingClientRect();if(g.set(i.x-s.left,i.y-s.top),m.set(v(g)),i.button===$){const n=i.currentTarget;if(!n)return;(n.lastClick??0)-(n.lastClick=Date.now())>-200?n.clicks=(n.clicks||0)+1:n.clicks=1,n.clicks>=2&&(n.clicks=0,y||e.push(y=new O({_type:"entity",id:crypto.randomUUID(),name:"Unnamed",x:m.x,y:m.y})))}}function q(i){const s=t.value.getBoundingClientRect();if(g.set(i.x-s.left,i.y-s.top),m.set(v(g)),i.button===$){y&&(y.highlight=!1,y=null);const n=A(e);for(const l of n)if(l.getShapeWorld().contains(m)){(y=l).highlight=!0;break}y?(h="dragging",b.set(m.minus(y))):(h="empty",C.set(f),b.set(g))}}function H(i){const s=t.value.getBoundingClientRect();g.set(i.x-s.left,i.y-s.top),m.set(v(g)),h=""}function K(i){const s=t.value.getBoundingClientRect();g.set(i.x-s.left,i.y-s.top),m.set(v(g)),h==="empty"?f.set(C.add(g.minus(b).div(w))):h==="dragging"&&y&&y.set(m.minus(b))}function X(i){switch(i.key){case"Backspace":y&&(i.metaKey||i.ctrlKey)&&G(y);break}console.log(i)}function Y(i){const s=t.value.getBoundingClientRect(),n=new u({x:i.x-s.left,y:i.y-s.top}),l=n.divide(w);w*=Math.pow(.9,i.deltaY/300);const d=n.divide(w);f.incre(d.minus(l))}function G(i){for(const s of e.filter(n=>n._type==="relationship")){const n=s;n.removeRelations(n.relations.filter(l=>l.entity===i))}}function Q(i){const s=t.value.getBoundingClientRect(),n=v(new u({x:i.x-s.left,y:i.y-s.top})),l=j(i.dataTransfer?.getData("type"));if(!l)return;const d=new l({id:crypto.randomUUID(),x:n.x,y:n.y,name:"Unnamed",_type:i.dataTransfer?.getData("type")});e.push(d)}function v(i){return i.divide(w).decre(f)}return(i,s)=>(nt(),et("div",lt,[it("canvas",{class:"mx--3 absolute top-0 left-0 w-full h-full",id:"editor",ref_key:"editor",ref:t,tabindex:"1",onDrop:st(Q,["prevent"]),onWheel:Y,onClick:N,onMousedown:q,onMouseup:H,onMousemove:K,onKeydown:X},null,544)]))}}),pt=rt(dt,[["__scopeId","data-v-0cc622e2"]]);export{pt as default};
